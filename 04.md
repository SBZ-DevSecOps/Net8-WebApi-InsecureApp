# OWASP API4:2023 — Unrestricted Resource Consumption

## 📚 Description

**Unrestricted Resource Consumption** (API4:2023) désigne une vulnérabilité où une API permet à un attaquant de consommer librement, sans restriction, les ressources du serveur (CPU, mémoire, fichiers, réseau), menant à une dégradation de service (DoS), à des coûts imprévus, ou à une indisponibilité de l’application pour les utilisateurs légitimes.

## 🧑‍💻 Endpoints vulnérables dans cette solution

> Tous les endpoints sont exposés dans :  
> **`Api04ResourceConsumptionController.cs`**  
> Préfixe de route : `/api/rc`

### 1. **Listing massif sans pagination**

- **GET** `/api/rc/users/all`
- Retourne l’intégralité des utilisateurs en base, sans pagination ni limite.
- **Exploit** : Un client peut télécharger toute la table, surcharger mémoire et réseau.

---

### 2. **Export CSV massif**

- **GET** `/api/rc/export-csv?count={n}`
- Retourne jusqu’à `n` utilisateurs dans un CSV unique, sans limite supérieure autre que le stock en base.
- **Exploit** : Un attaquant peut demander un CSV très volumineux (`count=1000000`), saturant CPU/RAM.

---

### 3. **Calcul coûteux sans limite**

- **GET** `/api/rc/hash-password?password=xxx&rounds={n}`
- Calcule un hash PBKDF2 avec un nombre de tours paramétrable (`rounds`).
- **Exploit** : En passant `rounds=99999999`, un attaquant provoque une saturation CPU.

---

### 4. **Bulk Create illimité**

- **POST** `/api/rc/bulk-create-orders`
- Permet d’insérer un tableau JSON de commandes, sans limitation de nombre ou de taille.
- **Exploit** : Un attaquant envoie un payload de milliers d’ordres, saturant disque, base et réseau.

---

## ⚠️ Scénarios d’exploitation

- **Denial of Service (DoS)** par surcharge du serveur ou de la base.
- **Augmentation de coût** (cloud, stockage, CPU).
- **Fuite de données** (extraction massive, data exfiltration).

---

## 🚩 Pourquoi ces endpoints sont-ils vulnérables ?

Aucune limitation, pagination, quota, authentification forte, ou rate limiting n’est appliqué.
Ils sont ainsi **parfaitement détectables** par :
- **SAST** (Snyk, Checkmarx, JFrog…) — absence de pagination, pas de contrôle de taille de payload
- **DAST** (Burp, ZAP, APIsec, Postman…) — tests de fuzz, volumétrie, timeouts

---

## 🔎 Points à rechercher lors d’un audit

- Endpoints GET massifs sans paramètres de paging/limit.
- Export de données sans quota/max results.
- Opérations POST/PUT/DELETE bulk sans plafond de volume.
- Possibilité pour l’attaquant d’ajuster la consommation via des paramètres de requête.

---

## 💡 Conseils de remédiation (bonnes pratiques)

- Toujours limiter le nombre de résultats renvoyés par défaut (et mettre une limite max côté API, même si le client la change).
- Implémenter une pagination sur tous les listings.
- Ajouter des quotas sur les payloads bulk.
- Limiter la puissance de calcul des endpoints paramétrables.
- Mettre en place du **rate limiting** et du **monitoring**.

---

## 🧪 Exemples de requêtes de test

```http
GET /api/rc/users/all
GET /api/rc/export-csv?count=100000
GET /api/rc/hash-password?password=secret&rounds=10000000
POST /api/rc/bulk-create-orders
Content-Type: application/json
[
  { "userId": 1, "amount": 10, "status": "Pending", "createdAt": "2024-07-14T12:00:00Z" },
  ...
]
